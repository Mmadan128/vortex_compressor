<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: training_loop Pages: 1 -->
<svg width="496pt" height="1130pt"
 viewBox="0.00 0.00 495.50 1129.74" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1125.74)">
<title>training_loop</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-1125.74 491.5,-1125.74 491.5,4 -4,4"/>
<text text-anchor="middle" x="243.75" y="-1104.94" font-family="Arial" font-size="16.00">Training Loop with Compressive Memory Management</text>
<!-- start -->
<g id="node1" class="node">
<title>start</title>
<ellipse fill="#e1ffe1" stroke="black" cx="173.5" cy="-1054.24" rx="146.24" ry="26.74"/>
<text text-anchor="middle" x="173.5" y="-1058.04" font-family="Arial" font-size="14.00">Start Epoch</text>
<text text-anchor="middle" x="173.5" y="-1043.04" font-family="Arial" font-size="14.00">compressed_memories = None</text>
</g>
<!-- load_batch -->
<g id="node2" class="node">
<title>load_batch</title>
<path fill="#e1f5ff" stroke="black" d="M221,-975.74C221,-975.74 126,-975.74 126,-975.74 120,-975.74 114,-969.74 114,-963.74 114,-963.74 114,-934.74 114,-934.74 114,-928.74 120,-922.74 126,-922.74 126,-922.74 221,-922.74 221,-922.74 227,-922.74 233,-928.74 233,-934.74 233,-934.74 233,-963.74 233,-963.74 233,-969.74 227,-975.74 221,-975.74"/>
<text text-anchor="middle" x="173.5" y="-960.54" font-family="Arial" font-size="14.00">Load Batch</text>
<text text-anchor="middle" x="173.5" y="-945.54" font-family="Arial" font-size="14.00">32 × 512 bytes</text>
<text text-anchor="middle" x="173.5" y="-930.54" font-family="Arial" font-size="14.00">from DataLoader</text>
</g>
<!-- start&#45;&gt;load_batch -->
<g id="edge1" class="edge">
<title>start&#45;&gt;load_batch</title>
<path fill="none" stroke="black" d="M173.5,-1027.25C173.5,-1014.71 173.5,-999.48 173.5,-985.88"/>
<polygon fill="black" stroke="black" points="177,-985.87 173.5,-975.87 170,-985.87 177,-985.87"/>
</g>
<!-- forward -->
<g id="node3" class="node">
<title>forward</title>
<path fill="#ccffcc" stroke="black" d="M190.5,-885.74C190.5,-885.74 40.5,-885.74 40.5,-885.74 34.5,-885.74 28.5,-879.74 28.5,-873.74 28.5,-873.74 28.5,-814.74 28.5,-814.74 28.5,-808.74 34.5,-802.74 40.5,-802.74 40.5,-802.74 190.5,-802.74 190.5,-802.74 196.5,-802.74 202.5,-808.74 202.5,-814.74 202.5,-814.74 202.5,-873.74 202.5,-873.74 202.5,-879.74 196.5,-885.74 190.5,-885.74"/>
<text text-anchor="middle" x="115.5" y="-870.54" font-family="Arial" font-size="14.00">Forward Pass</text>
<text text-anchor="middle" x="115.5" y="-855.54" font-family="Arial" font-size="14.00">logits, memories = model(</text>
<text text-anchor="middle" x="115.5" y="-840.54" font-family="Arial" font-size="14.00"> &#160;batch,</text>
<text text-anchor="middle" x="115.5" y="-825.54" font-family="Arial" font-size="14.00"> &#160;compressed_memories</text>
<text text-anchor="middle" x="115.5" y="-810.54" font-family="Arial" font-size="14.00">)</text>
</g>
<!-- load_batch&#45;&gt;forward -->
<g id="edge2" class="edge">
<title>load_batch&#45;&gt;forward</title>
<path fill="none" stroke="black" d="M159.01,-922.51C154.24,-914.03 148.75,-904.29 143.32,-894.64"/>
<polygon fill="black" stroke="black" points="146.32,-892.85 138.37,-885.85 140.22,-896.28 146.32,-892.85"/>
</g>
<!-- update_mem -->
<g id="node4" class="node">
<title>update_mem</title>
<path fill="#ffffcc" stroke="black" d="M184.5,-765.74C184.5,-765.74 38.5,-765.74 38.5,-765.74 32.5,-765.74 26.5,-759.74 26.5,-753.74 26.5,-753.74 26.5,-724.74 26.5,-724.74 26.5,-718.74 32.5,-712.74 38.5,-712.74 38.5,-712.74 184.5,-712.74 184.5,-712.74 190.5,-712.74 196.5,-718.74 196.5,-724.74 196.5,-724.74 196.5,-753.74 196.5,-753.74 196.5,-759.74 190.5,-765.74 184.5,-765.74"/>
<text text-anchor="middle" x="111.5" y="-750.54" font-family="Arial" font-size="14.00">Updated Memories</text>
<text text-anchor="middle" x="111.5" y="-735.54" font-family="Arial" font-size="14.00">8 layers × memory states</text>
<text text-anchor="middle" x="111.5" y="-720.54" font-family="Arial" font-size="14.00">[batch, mem_len, 512]</text>
</g>
<!-- forward&#45;&gt;update_mem -->
<g id="edge3" class="edge">
<title>forward&#45;&gt;update_mem</title>
<path fill="none" stroke="black" d="M113.92,-802.53C113.58,-793.74 113.22,-784.5 112.89,-775.92"/>
<polygon fill="black" stroke="black" points="116.38,-775.7 112.49,-765.84 109.39,-775.97 116.38,-775.7"/>
</g>
<!-- loss -->
<g id="node5" class="node">
<title>loss</title>
<path fill="#ccccff" stroke="black" d="M191,-675.74C191,-675.74 18,-675.74 18,-675.74 12,-675.74 6,-669.74 6,-663.74 6,-663.74 6,-634.74 6,-634.74 6,-628.74 12,-622.74 18,-622.74 18,-622.74 191,-622.74 191,-622.74 197,-622.74 203,-628.74 203,-634.74 203,-634.74 203,-663.74 203,-663.74 203,-669.74 197,-675.74 191,-675.74"/>
<text text-anchor="middle" x="104.5" y="-660.54" font-family="Arial" font-size="14.00">Compute Loss</text>
<text text-anchor="middle" x="104.5" y="-645.54" font-family="Arial" font-size="14.00">Cross&#45;Entropy</text>
<text text-anchor="middle" x="104.5" y="-630.54" font-family="Arial" font-size="14.00">BPD = &#45;Σ log₂ p(x_i|x_{&lt;i}) / N</text>
</g>
<!-- update_mem&#45;&gt;loss -->
<g id="edge4" class="edge">
<title>update_mem&#45;&gt;loss</title>
<path fill="none" stroke="black" d="M109.44,-712.31C108.78,-704.08 108.05,-694.82 107.35,-686.02"/>
<polygon fill="black" stroke="black" points="110.83,-685.67 106.55,-675.98 103.85,-686.23 110.83,-685.67"/>
</g>
<!-- backward -->
<g id="node6" class="node">
<title>backward</title>
<path fill="#ffcccc" stroke="black" d="M158,-585.74C158,-585.74 51,-585.74 51,-585.74 45,-585.74 39,-579.74 39,-573.74 39,-573.74 39,-544.74 39,-544.74 39,-538.74 45,-532.74 51,-532.74 51,-532.74 158,-532.74 158,-532.74 164,-532.74 170,-538.74 170,-544.74 170,-544.74 170,-573.74 170,-573.74 170,-579.74 164,-585.74 158,-585.74"/>
<text text-anchor="middle" x="104.5" y="-570.54" font-family="Arial" font-size="14.00">Backward Pass</text>
<text text-anchor="middle" x="104.5" y="-555.54" font-family="Arial" font-size="14.00">loss.backward()</text>
<text text-anchor="middle" x="104.5" y="-540.54" font-family="Arial" font-size="14.00">Compute gradients</text>
</g>
<!-- loss&#45;&gt;backward -->
<g id="edge5" class="edge">
<title>loss&#45;&gt;backward</title>
<path fill="none" stroke="black" d="M104.5,-622.31C104.5,-614.08 104.5,-604.82 104.5,-596.02"/>
<polygon fill="black" stroke="black" points="108,-595.98 104.5,-585.98 101,-595.98 108,-595.98"/>
</g>
<!-- clip -->
<g id="node7" class="node">
<title>clip</title>
<path fill="#ffddcc" stroke="black" d="M153.5,-495.74C153.5,-495.74 55.5,-495.74 55.5,-495.74 49.5,-495.74 43.5,-489.74 43.5,-483.74 43.5,-483.74 43.5,-469.74 43.5,-469.74 43.5,-463.74 49.5,-457.74 55.5,-457.74 55.5,-457.74 153.5,-457.74 153.5,-457.74 159.5,-457.74 165.5,-463.74 165.5,-469.74 165.5,-469.74 165.5,-483.74 165.5,-483.74 165.5,-489.74 159.5,-495.74 153.5,-495.74"/>
<text text-anchor="middle" x="104.5" y="-480.54" font-family="Arial" font-size="14.00">Gradient Clipping</text>
<text text-anchor="middle" x="104.5" y="-465.54" font-family="Arial" font-size="14.00">max_norm=1.0</text>
</g>
<!-- backward&#45;&gt;clip -->
<g id="edge6" class="edge">
<title>backward&#45;&gt;clip</title>
<path fill="none" stroke="black" d="M104.5,-532.33C104.5,-524.05 104.5,-514.85 104.5,-506.39"/>
<polygon fill="black" stroke="black" points="108,-506.21 104.5,-496.21 101,-506.21 108,-506.21"/>
</g>
<!-- optimize -->
<g id="node8" class="node">
<title>optimize</title>
<path fill="#ffe1cc" stroke="black" d="M167.5,-420.74C167.5,-420.74 39.5,-420.74 39.5,-420.74 33.5,-420.74 27.5,-414.74 27.5,-408.74 27.5,-408.74 27.5,-364.74 27.5,-364.74 27.5,-358.74 33.5,-352.74 39.5,-352.74 39.5,-352.74 167.5,-352.74 167.5,-352.74 173.5,-352.74 179.5,-358.74 179.5,-364.74 179.5,-364.74 179.5,-408.74 179.5,-408.74 179.5,-414.74 173.5,-420.74 167.5,-420.74"/>
<text text-anchor="middle" x="103.5" y="-405.54" font-family="Arial" font-size="14.00">Optimizer Step</text>
<text text-anchor="middle" x="103.5" y="-390.54" font-family="Arial" font-size="14.00">AdamW</text>
<text text-anchor="middle" x="103.5" y="-375.54" font-family="Arial" font-size="14.00">Update 14.8M params</text>
<text text-anchor="middle" x="103.5" y="-360.54" font-family="Arial" font-size="14.00">zero_grad()</text>
</g>
<!-- clip&#45;&gt;optimize -->
<g id="edge7" class="edge">
<title>clip&#45;&gt;optimize</title>
<path fill="none" stroke="black" d="M104.29,-457.51C104.2,-449.74 104.1,-440.33 103.99,-430.96"/>
<polygon fill="black" stroke="black" points="107.49,-430.85 103.88,-420.89 100.49,-430.93 107.49,-430.85"/>
</g>
<!-- detach -->
<g id="node9" class="node">
<title>detach</title>
<path fill="#ff9999" stroke="black" stroke-width="3" d="M191,-315.74C191,-315.74 12,-315.74 12,-315.74 6,-315.74 0,-309.74 0,-303.74 0,-303.74 0,-229.74 0,-229.74 0,-223.74 6,-217.74 12,-217.74 12,-217.74 191,-217.74 191,-217.74 197,-217.74 203,-223.74 203,-229.74 203,-229.74 203,-303.74 203,-303.74 203,-309.74 197,-315.74 191,-315.74"/>
<text text-anchor="middle" x="101.5" y="-300.54" font-family="Arial" font-size="14.00">★ DETACH MEMORIES ★</text>
<text text-anchor="middle" x="101.5" y="-285.54" font-family="Arial" font-size="14.00">compressed_memories = [</text>
<text text-anchor="middle" x="101.5" y="-270.54" font-family="Arial" font-size="14.00"> &#160;m.detach() for m in memories</text>
<text text-anchor="middle" x="101.5" y="-255.54" font-family="Arial" font-size="14.00">]</text>
<text text-anchor="middle" x="101.5" y="-240.54" font-family="Arial" font-size="14.00">Breaks gradient flow</text>
<text text-anchor="middle" x="101.5" y="-225.54" font-family="Arial" font-size="14.00">Preserves activations</text>
</g>
<!-- optimize&#45;&gt;detach -->
<g id="edge8" class="edge">
<title>optimize&#45;&gt;detach</title>
<path fill="none" stroke="black" d="M102.94,-352.56C102.8,-344.33 102.64,-335.28 102.49,-326.24"/>
<polygon fill="black" stroke="black" points="105.99,-326.03 102.32,-316.09 98.99,-326.15 105.99,-326.03"/>
</g>
<!-- check -->
<g id="node10" class="node">
<title>check</title>
<path fill="#ffffee" stroke="black" d="M155.92,-175.08C155.92,-175.08 106.08,-148.4 106.08,-148.4 100.79,-145.57 100.79,-139.91 106.08,-137.08 106.08,-137.08 155.92,-110.4 155.92,-110.4 161.21,-107.57 171.79,-107.57 177.08,-110.4 177.08,-110.4 226.92,-137.08 226.92,-137.08 232.21,-139.91 232.21,-145.57 226.92,-148.4 226.92,-148.4 177.08,-175.08 177.08,-175.08 171.79,-177.91 161.21,-177.91 155.92,-175.08"/>
<text text-anchor="middle" x="166.5" y="-146.54" font-family="Arial" font-size="14.00">More</text>
<text text-anchor="middle" x="166.5" y="-131.54" font-family="Arial" font-size="14.00">batches?</text>
</g>
<!-- detach&#45;&gt;check -->
<g id="edge9" class="edge">
<title>detach&#45;&gt;check</title>
<path fill="none" stroke="black" d="M127.19,-217.52C133.57,-205.54 140.32,-192.87 146.4,-181.47"/>
<polygon fill="black" stroke="black" points="149.49,-183.11 151.1,-172.64 143.31,-179.82 149.49,-183.11"/>
</g>
<!-- check&#45;&gt;load_batch -->
<g id="edge10" class="edge">
<title>check&#45;&gt;load_batch</title>
<path fill="none" stroke="black" d="M189.23,-168.81C207.98,-192.14 231.5,-228.78 231.5,-265.74 231.5,-845.24 231.5,-845.24 231.5,-845.24 231.5,-870.63 217.96,-895.53 203.96,-914.48"/>
<polygon fill="black" stroke="black" points="201.12,-912.44 197.76,-922.49 206.65,-916.73 201.12,-912.44"/>
<text text-anchor="middle" x="263.5" y="-570.54" font-family="Times,serif" font-size="14.00" fill="darkgreen">Yes</text>
<text text-anchor="middle" x="263.5" y="-555.54" font-family="Times,serif" font-size="14.00" fill="darkgreen">(memory</text>
<text text-anchor="middle" x="263.5" y="-540.54" font-family="Times,serif" font-size="14.00" fill="darkgreen">persists)</text>
</g>
<!-- end_epoch -->
<g id="node11" class="node">
<title>end_epoch</title>
<ellipse fill="#ffe1e1" stroke="black" cx="166.5" cy="-26.87" rx="82.05" ry="26.74"/>
<text text-anchor="middle" x="166.5" y="-30.67" font-family="Arial" font-size="14.00">End Epoch</text>
<text text-anchor="middle" x="166.5" y="-15.67" font-family="Arial" font-size="14.00">Save checkpoint</text>
</g>
<!-- check&#45;&gt;end_epoch -->
<g id="edge11" class="edge">
<title>check&#45;&gt;end_epoch</title>
<path fill="none" stroke="black" d="M166.5,-104.45C166.5,-91.58 166.5,-77.19 166.5,-64.38"/>
<polygon fill="black" stroke="black" points="170,-64.06 166.5,-54.06 163,-64.06 170,-64.06"/>
<text text-anchor="middle" x="177" y="-75.54" font-family="Times,serif" font-size="14.00">No</text>
</g>
<!-- mem_note -->
<g id="node12" class="node">
<title>mem_note</title>
<polygon fill="#ffffdd" stroke="black" points="481.5,-1095.74 337.5,-1095.74 337.5,-1012.74 487.5,-1012.74 487.5,-1089.74 481.5,-1095.74"/>
<polyline fill="none" stroke="black" points="481.5,-1095.74 481.5,-1089.74 "/>
<polyline fill="none" stroke="black" points="487.5,-1089.74 481.5,-1089.74 "/>
<text text-anchor="middle" x="412.5" y="-1080.54" font-family="Arial" font-size="14.00">Critical:</text>
<text text-anchor="middle" x="412.5" y="-1065.54" font-family="Arial" font-size="14.00">Memory state persists</text>
<text text-anchor="middle" x="412.5" y="-1050.54" font-family="Arial" font-size="14.00">across batches but</text>
<text text-anchor="middle" x="412.5" y="-1035.54" font-family="Arial" font-size="14.00">gradients do not flow</text>
<text text-anchor="middle" x="412.5" y="-1020.54" font-family="Arial" font-size="14.00">through history</text>
</g>
</g>
</svg>
